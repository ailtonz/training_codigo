/****** CONSOLIDADO  ******/
SELECT TOP 1000 [ID],[ID_SEGMENTO],[SEG_DESCR]
	,[NOTA_FISCAL]
	,[CONTA]
	,[PROCV]
	,[SALDO_CAR]
	FROM [DB_SISCOB].[CONSOLIDADO].[TB_CONSOLIDADO]
	WHERE  ID_TIPO=3 and [SEG_DESCR] not like '%VPG%'
	AND NOTA_FISCAL='0000000051'


/****** PAGAMENTO E AJUSTES  ******/
SELECT 
	[CONTA]
	,[DT_CORTE]
	,[CHAVE] 
	,[VALOR_PAGTO] as [VALOR_PAGTO]
	,[VALOR_AJUSTE] as [VALOR_AJUSTE]
FROM 
[DB_SISCOB_HML].[TRANSITO_PAGAMENTO_AJUSTE].[CAR_MANUAL_v06]
where 
[VALOR_PAGTO] = '2379650.01' --- 88888881000000005104/20152379650,01

--#################################################
--[TRANSITO_PAGAMENTO_AJUSTE].[_OK_PRC_CAR_MANUAL] 
--#################################################

SELECT 
	AJUSTE.NF AS CONTA
	, ISNULL(AJUSTE.[Emissao],0) AS DT_CORTE
	,CASE 
		WHEN 
			ISNULL(AJUSTE.Canc,0) > 0  THEN 0
		ELSE 
			ISNULL(AJUSTE.VALOR_FAT,0) 
	END AS VALOR_PAGTO
	, ISNULL(AJUSTE.Canc,0)  AS VALOR_AJUSTE
	, CONCAT(REPLICATE('0',8-LEN(AJUSTE.Raiz)),AJUSTE.Raiz, REPLICATE('0',10-LEN(AJUSTE.[nf])),AJUSTE.[nf], RIGHT(CONVERT(CHAR(10),AJUSTE.[Emissao],103),7),REPLACE(AJUSTE.VALOR_FAT,'.',''),'') AS CHAVE

	--INTO [DB_SISCOB_HML].[TRANSITO_PAGAMENTO_AJUSTE].[CAR_MANUAL_v06]
FROM
[DB_SISCOB_HML].[TRANSITO_PAGAMENTO_AJUSTE].[TMP_CAR_MANUAL_v06] AJUSTE

--################################################################
--[TRANSITO_PAGAMENTO_AJUSTE].[_OK_PRC_ATLYS_AJUSTES_E_PAGAMENTOS] 
--################################################################

--DROP TABLE [DB_SISCOB_HML].[TRANSITO_PAGAMENTO_AJUSTE].[ATLYS_AJUSTES]

SELECT 
	AJ_ATLYS.CONTA AS CONTA
	, MAX(AJ_ATLYS.DATA) AS DT_CORTE
	, Sum(AJ_ATLYS.Valor) AS VALOR_AJUSTE
	, CONCAT(AJ_ATLYS.CONTA, CONVERT(DATE,AJ_ATLYS.[PROCESS])) AS CHAVE
	INTO [DB_SISCOB_HML].[TRANSITO_PAGAMENTO_AJUSTE].[ATLYS_AJUSTES]
FROM
	[DB_SISCOB_HML].[TRANSITO_PAGAMENTO_AJUSTE].[tmp_ATLYS_AJUSTES] AJ_ATLYS
GROUP BY 
	AJ_ATLYS.CONTA
	,AJ_ATLYS.[PROCESS]
	
--###########################################################
--[TRANSITO_PAGAMENTO_AJUSTE].[_NOK_PRC_LEGADO]
--###########################################################	

SELECT 
	AJUSTE.Nrc AS CONTA
	, ISNULL(AJUSTE.dtConta,0) AS DT_CORTE

	, ISNULL(AJUSTE.vlConta,0) AS VALOR_PAGTO

	--, ISNULL(AJUSTE.Canc,0)  AS VALOR_AJUSTE
	
	, CONCAT(AJUSTE.Nrc, AJUSTE.dtConta,AJUSTE.Tel) AS CHAVE
	--INTO [DB_SISCOB_HML].[TRANSITO_PAGAMENTO_AJUSTE].[LEGADO]
FROM
	[DB_SISCOB_HML].[TRANSITO_PAGAMENTO_AJUSTE].[tmp_LEGADO] AJUSTE

--###########################################################	
--[TRANSITO_PAGAMENTO_AJUSTE].[_NOK_PRC_ATELECOM]
--###########################################################

SELECT 
	AJUSTE.NotaFiscal AS CONTA
	, ISNULL(AJUSTE.DtMovimento,0) AS DT_CORTE
	,CASE 
		WHEN 
			convert(decimal(10,2),AJUSTE.VlCorrecao) + convert(decimal(10,2),AJUSTE.VlDesconto) > 0  THEN 0
		ELSE 
			convert(decimal(10,2),AJUSTE.VlMovimento)
	END AS VALOR_PAGTO

	, convert(decimal(10,2),AJUSTE.VlCorrecao) + convert(decimal(10,2),AJUSTE.VlDesconto)  AS VALOR_AJUSTE
	, CONCAT(AJUSTE.NotaFiscal, AJUSTE.CodCliente, AJUSTE.LojaCliente) AS CHAVE

	--INTO [DB_SISCOB_HML].[TRANSITO_PAGAMENTO_AJUSTE].[ATELECOM]

FROM
	[DB_SISCOB_HML].[TRANSITO_PAGAMENTO_AJUSTE].[tmp_ATELECOM] AJUSTE	