-- TI.RAIZ_CPF_CNPJ + ISNULL(FI.[NOTA_FISCAL],'') + ISNULL(FI.[DtConta],'') + ISNULL(REPLACE(FI.[SALDO_CAR],'.',''),'')
drop table [DB_SISCOB_HML].[TRANSITO_PAGAMENTO_AJUSTE].[CAR_MANUAL];

SELECT 
	AJUSTE.NF AS CONTA
	, ISNULL(AJUSTE.[Emissao],0) AS DT_CORTE
	,CASE 
		WHEN 
			ISNULL(AJUSTE.Canc,0) > 0  THEN 0
		ELSE 
			ISNULL(AJUSTE.VALOR_FAT,0) 
	END AS VALOR_PAGTO
	, ISNULL(AJUSTE.Canc,0)  AS VALOR_AJUSTE
	, CONCAT(REPLICATE('0',8-LEN(AJUSTE.Raiz)),AJUSTE.Raiz, REPLICATE('0',10-LEN(AJUSTE.[nf])),AJUSTE.[nf], RIGHT(CONVERT(CHAR(10),AJUSTE.[Emissao],103),7),ISNULL(REPLACE(AJUSTE.VALOR_FAT,'.',''),'')) AS CHAVE
INTO [DB_SISCOB_HML].[TRANSITO_PAGAMENTO_AJUSTE].[CAR_MANUAL]
FROM
[DB_SISCOB_HML].[TRANSITO_PAGAMENTO_AJUSTE].[TMP_CAR_MANUAL] AJUSTE


--select * from [DB_SISCOB_HML].[TRANSITO_PAGAMENTO_AJUSTE].[CAR_MANUAL]


/****** PAGAMENTO E AJUSTES  ******/
SELECT 
	[CONTA]
	,[DT_CORTE]
	,[CHAVE] 
	,sum([VALOR_PAGTO]) as [VALOR_PAGTO]
	,sum([VALOR_AJUSTE]) as [VALOR_AJUSTE]
FROM [DB_SISCOB_HML].[TRANSITO_PAGAMENTO_AJUSTE].[CAR_MANUAL]
where 
chave = '40432544000000004405/2012166019'
--conta = '51'
group by
	[CONTA]
	,[DT_CORTE]
	,[CHAVE]

/****** CONSOLIDADO  ******/
SELECT TOP 1000 [ID],[ID_SEGMENTO],[SEG_DESCR]
	,[NOTA_FISCAL]
	,[CONTA]
	,[PROCV]
	,[SALDO_CAR]
	FROM [DB_SISCOB].[CONSOLIDADO].[TB_CONSOLIDADO]
	WHERE  ID_TIPO=3 and [SEG_DESCR] not like '%VPG%'
	and procv='40432544000000004405/2012166019'
	--AND NOTA_FISCAL='0000000051'
