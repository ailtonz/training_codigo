USE [DB_SISCOB]
GO

/****** Object:  View [APP_EXCEL].[VW_RELATORIO_WEB_MIS_VPE_FIXA_SIM]    Script Date: 11/29/2016 2:02:02 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO




ALTER VIEW [APP_EXCEL].[VW_RELATORIO_WEB_MIS_VPE_FIXA_SIM]
AS

/****** Script for SelectTopNRows command from SSMS  ******/
SELECT  
	
	 C.PROCV
	,CS.ID_CONSOLIDADO												AS ID
	,AN.fname + space(1) + AN.lname									AS NOME_ANALISTA
	,ANT.fname + space(1) + ANT.lname								AS NOME_ANALISTA_TMP
	,AL.fname + space(1) + AL.lname									AS NOME_LIDER
	,AA.FOCO														AS FEEDBACK
	,AA.AREA_OFENSORA												AS AREA_OFENSORA
	,TA.DESCRICAO													AS TIPO_PAGTO
	,CONVERT(VARCHAR(10),CONVERT(DATE,HA.DT_PAGAMENTO,106),103)		AS DT_PAGTO
	,HA.VALOR_PAGO													AS VALOR_PAGTO
	,CONVERT(VARCHAR(10),CONVERT(DATE,HA.DT_AJUSTE,106),103)		AS DT_AJUSTE
	,HA.VALOR_AJUSTE												AS VALOR_AJUSTADO
	,[DB_SISCOB].[AUXILIAR].[FN_FORMATAR_TEXTO](HA.RE_PROBLEMA)		AS RESUMO_EXECUTIVO_PROBLEMA
	,[DB_SISCOB].[AUXILIAR].[FN_FORMATAR_TEXTO](HA.RE_ACAO)			AS RESUMO_EXECUTIVO_ACAO
	,[DB_SISCOB].[AUXILIAR].[FN_FORMATAR_TEXTO](HA.HD_ACUMULADO)	AS HISTORICO_DETALHADO
	,CONVERT(VARCHAR(10),CONVERT(DATE,HA.DT_FOLLOW,106),103)		AS DT_FOLLOW_UP
	,CONVERT(VARCHAR(10),CONVERT(DATE,HA.DT_CONTATO,106),103)		AS DT_CONTATO
	,[DB_SISCOB].[AUXILIAR].[FN_FORMATAR_TEXTO](HA.RESPONSAVEL)		AS RESPONSAVEL
	,C.NV_FX_FORNECE												AS FAIXA_FORNECEDOR
	,C.NV_FX_FECHO													AS FAIXA_FECHO
	,V1.NV_FX_ARRECADA												AS FAIXA_ARRECADA_INICIAL
	,VA.NV_FX_ARRECADA												AS FAIXA_ARRECADA_ATUAL
	,C.RAIZ_GRUPO
	,C.NOME_GRUPO													AS GRUPO
	,C.RAIZ_CPF_CNPJ												AS RAIZ
	,C.CPF_CNPJ														AS CNPJ
	,C.CLIENTE														AS NOME
	,C.RAZAO_SOCIAL													AS NOME_CLIENTE
	,C.TIPO	
	,C.EMPRESA
	,C.CONTA
	,C.TEL
	,C.LOCAL
	,C.TERMINAL
	,C.DV
	,C.NRC
	,C.CLASSERV
	,C.TITULO
	,C.FILIAL
	,C.LJ_CLI
	,C.COD_CLI
	,C.DOCUMENTO_SAP
	,C.DOC_FAT
	,C.N_DOC_DE_PARA_ATLYS
	,C.NOTA_FISCAL
	,CONVERT(VARCHAR(10),CONVERT(DATE,C.VENC_ATUAL,106),103)		AS VENC_ATUAL
	,CONVERT(VARCHAR(10),CONVERT(DATE,C.VENC_ORIGINAL,106),103)		AS VENC_ORIGINAL
	,CONVERT(VARCHAR(10),CONVERT(DATE,C.[DT_PROCESS],106),103)		AS DT_PROCESS
	,C.ANOMES
	,C.DIA_VENCIMENTO												AS DIA_VENCIMENTO_LOTE
	,C.NUMERO_LOTE
	,C.VALOR_LOTE	
	,V1.SALDO_CAR													AS SALDO_CAR_26
	,V2.SALDO_CAR													AS SALDO_CAR_05
	,VN.SALDO_CAR													AS SALDO_CAR_30
	,V3.SALDO_CAR													AS SALDO_CAR_14
	,V4.SALDO_CAR													AS SALDO_CAR_21
	,V5.SALDO_CAR													AS SALDO_CAR_25
	,VA.SALDO_CAR													AS SALDO_TOTAL
	,ISNULL(V1.SALDO_FX_ENT,0) + 
	 ISNULL(V1.SALDO_PDD,0)											AS SOMA_FXE_PDD_26
	,ISNULL(VN.SALDO_FX_ENT,0) + 
	 ISNULL(VN.SALDO_PDD,0)											AS SOMA_FXE_PDD_30
	,ISNULL(V2.SALDO_FX_ENT,0) + 
	 ISNULL(V2.SALDO_PDD,0)											AS SOMA_FXE_PDD_05
	,ISNULL(V3.SALDO_FX_ENT,0) + 
	 ISNULL(V3.SALDO_PDD,0)											AS SOMA_FXE_PDD_14
	,ISNULL(V4.SALDO_FX_ENT,0) + 
	 ISNULL(V4.SALDO_PDD,0)											AS SOMA_FXE_PDD_21
	,ISNULL(V5.SALDO_FX_ENT,0) + 
	 ISNULL(V5.SALDO_PDD,0)											AS SOMA_FXE_PDD_25
	
	,ISNULL(PG.VALOR_PAGTO,0)										AS VALOR_PAGAMENTO
	,ISNULL(PG.VALOR_AJUSTE,0)										AS VALOR_AJUSTE
	,PG.dt_atrib
	,C.DTCORTE
	
	,CASE 
		WHEN VA.SALDO_CAR IS NOT NULL THEN 
			VA.SALDO_CAR - ISNULL(PG.VALOR_PAGTO,0) -  ISNULL(PG.VALOR_AJUSTE,0)
		ELSE 0 
	 END AS															SALDO_ATUAL 
	
	
	,C.CICLO
	,C.UF
	,C.STATUS
	,C.CLASSE
	,C.SEGMENTO_GERENCIA
	,C.GN
	,C.GV
	,C.DIRETOR
	,C.ANALISTA_TLF_VIVO
	,C.INTRAGOV
	,C.INTERCOMPANY
	
	,A0.FOCO														AS FEEDBACK_00
	,A1.FOCO														AS FEEDBACK_01
	,A2.FOCO														AS FEEDBACK_02
	,A3.FOCO														AS FEEDBACK_03
	,A4.FOCO														AS FEEDBACK_04
	,A5.FOCO														AS FEEDBACK_05
	
	,AC.PENDENTE_ID													AS PENDENTE_ID_ANALISE_CONTA
	,CONVERT(VARCHAR(10),CONVERT(DATE,AC.PENDENTE_DATA,106),103)	AS PENDENTE_DATA_ANALISE_CONTA
	
	,AC.CONCLUIDO_ID												AS CONCLUIDO_ID_ANALISE_CONTA
	,CONVERT(VARCHAR(10),CONVERT(DATE,AC.CONCLUIDO_DATA,106),103)	AS CONCLUIDO_DATA_ANALISE_CONTA
	
	,AC.REABERTO_ID													AS REABERTO_ID_ANALISE_CONTA
	,CONVERT(VARCHAR(10),CONVERT(DATE,AC.REABERTO_DATA,106),103)	AS REABERTO_DATA_ANALISE_CONTA
	
	,C.QTD_REG_AGRUPADO
	
	,CONVERT(VARCHAR(10),CONVERT(DATE,HA.TIME_STAMP,106),103)		AS DT_ULT_ALTERACAO
	,UA.fname + space(1) + UA.lname									AS USUARIO_ATUALIZACAO
	
	,SG.SEGMENTO		AS AREA_ATUACAO
	,C.TASK_FORCE
	,C.SEG_DESCR
	,C.PARCELAMENTO
	,C.CONTA_BONUS
	,C.FORNECEDOR
	,CASE 
		WHEN CS.ID_STATUS_ESCALATION = 1 THEN 'BAIXADO'
		WHEN CS.ID_STATUS_ESCALATION = 2 THEN 'EM ANDAMENTO'
		WHEN CS.ID_STATUS_ESCALATION = 3 THEN 'ATENCAO'
		WHEN CS.ID_STATUS_ESCALATION = 4 THEN 'PENDENTE'
	 END AS ESCALATION
	,C.REGRA_PDD
	,C.FAIXA_CORTE
	,C.PROVISAO
	,C.[SITUACAO_SERVICO]
	,C.ENDERECO

	,ISNULL(V1.SALDO_FX_ENT,0)										AS SALDO_FX_ENT_26
	,ISNULL(V1.SALDO_PDD,0)											AS SALDO_PDD_26

	,ISNULL(VN.SALDO_FX_ENT,0)										AS SALDO_FX_ENT_30
	,ISNULL(VN.SALDO_PDD,0)											AS SALDO_PDD_30
	
	,ISNULL(V2.SALDO_FX_ENT,0)										AS SALDO_FX_ENT_05
	,ISNULL(V2.SALDO_PDD,0)											AS SALDO_PDD_05

	,ISNULL(V3.SALDO_FX_ENT,0)										AS SALDO_FX_ENT_14
	,ISNULL(V3.SALDO_PDD,0)											AS SALDO_PDD_14

	,ISNULL(V4.SALDO_FX_ENT,0)										AS SALDO_FX_ENT_21
	,ISNULL(V4.SALDO_PDD,0)											AS SALDO_PDD_21

	,ISNULL(V5.SALDO_FX_ENT,0)										AS SALDO_FX_ENT_25
	,ISNULL(V5.SALDO_PDD,0)											AS SALDO_PDD_25

	,C.RECEBIVEL

	
  
  FROM 
					[DB_SISCOB].[CONSOLIDADO].[TB_CONSUMO_SISCOB]	CS
		INNER JOIN  [DB_SISCOB].[CONSOLIDADO].[TB_CONSOLIDADO]		C	ON C.ID						= CS.ID_CONSOLIDADO 
		INNER JOIN  [DB_SISCOB].[AUXILIAR].[TB_SEGMENTO]			SG	ON SG.ID					= C.ID_SEGMENTO
		INNER JOIN	[DB_SISCOB].[AUXILIAR].[TB_PERIODO]				P   ON P.ID						= C.ID_PERIODO
		INNER JOIN  [DB_SISCOB].[AUXILIAR].[TB_TIPO]				TP  ON C.ID_TIPO                = TP.ID
		
		LEFT  JOIN  [DB_SISCOB].[CONSOLIDADO].[TB_DADOS_E_VALORES]  V1	ON CS.ID_VALORES_26			= V1.ID
		LEFT  JOIN  [DB_SISCOB].[CONSOLIDADO].[TB_DADOS_E_VALORES]  V2	ON CS.ID_VALORES_05			= V2.ID
		LEFT  JOIN  [DB_SISCOB].[CONSOLIDADO].[TB_DADOS_E_VALORES]  V3	ON CS.ID_VALORES_14			= V3.ID
		LEFT  JOIN  [DB_SISCOB].[CONSOLIDADO].[TB_DADOS_E_VALORES]  V4	ON CS.ID_VALORES_21			= V4.ID
		LEFT  JOIN  [DB_SISCOB].[CONSOLIDADO].[TB_DADOS_E_VALORES]  V5	ON CS.ID_VALORES_25			= V5.ID
		LEFT  JOIN  [DB_SISCOB].[CONSOLIDADO].[TB_DADOS_E_VALORES]  VA	ON CS.ID_VALOR_ATUAL		= VA.ID
		LEFT  JOIN  [DB_SISCOB].[CONSOLIDADO].[TB_DADOS_E_VALORES]  VN	ON CS.ID_VALORES_30			= VN.ID
		
		LEFT  JOIN  [DB_SISCOB].[CONSOLIDADO].[TB_HISTORICO]		H0	with(nolock) ON CS.ID_HISTORICO_SEMANA_0 = H0.ID
		LEFT  JOIN  [DB_SISCOB].[CONSOLIDADO].[TB_HISTORICO]		H1	with(nolock) ON CS.ID_HISTORICO_SEMANA_1 = H1.ID
		LEFT  JOIN  [DB_SISCOB].[CONSOLIDADO].[TB_HISTORICO]		H2	with(nolock) ON CS.ID_HISTORICO_SEMANA_2 = H2.ID
		LEFT  JOIN  [DB_SISCOB].[CONSOLIDADO].[TB_HISTORICO]		H3	with(nolock) ON CS.ID_HISTORICO_SEMANA_3 = H3.ID
		LEFT  JOIN  [DB_SISCOB].[CONSOLIDADO].[TB_HISTORICO]		H4	with(nolock) ON CS.ID_HISTORICO_SEMANA_4 = H4.ID
		LEFT  JOIN  [DB_SISCOB].[CONSOLIDADO].[TB_HISTORICO]		H5	with(nolock) ON CS.ID_HISTORICO_SEMANA_5 = H5.ID
		LEFT  JOIN  [DB_SISCOB].[CONSOLIDADO].[TB_HISTORICO]		HA	with(nolock) ON CS.ID_HISTORICO_ATUAL	= HA.ID
		
		LEFT  JOIN  [DB_SISCOB].[AUXILIAR].[TB_FOCO_AREA_OFENSORA]  AA	ON HA.ID_FOCO_FEEDBACK		= AA.ID 	
		LEFT  JOIN  [DB_SISCOB].[AUXILIAR].[TB_FOCO_AREA_OFENSORA]  A0	ON H0.ID_FOCO_FEEDBACK		= A0.ID 	
		LEFT  JOIN  [DB_SISCOB].[AUXILIAR].[TB_FOCO_AREA_OFENSORA]  A1	ON H1.ID_FOCO_FEEDBACK		= A1.ID 	
		LEFT  JOIN  [DB_SISCOB].[AUXILIAR].[TB_FOCO_AREA_OFENSORA]  A2	ON H2.ID_FOCO_FEEDBACK		= A2.ID 	
		LEFT  JOIN  [DB_SISCOB].[AUXILIAR].[TB_FOCO_AREA_OFENSORA]  A3	ON H3.ID_FOCO_FEEDBACK		= A3.ID 	
		LEFT  JOIN  [DB_SISCOB].[AUXILIAR].[TB_FOCO_AREA_OFENSORA]  A4	ON H4.ID_FOCO_FEEDBACK		= A4.ID 	
		LEFT  JOIN  [DB_SISCOB].[AUXILIAR].[TB_FOCO_AREA_OFENSORA]  A5	ON H5.ID_FOCO_FEEDBACK		= A5.ID 	
			
		LEFT  JOIN	[DB_SISCOB].[APP_WEB].[TBL_USUARIOS]			UA	ON HA.ID_ANALISTA			= UA.id_user
		LEFT  JOIN	[DB_SISCOB].[AUXILIAR].TB_TIPO_PAGAMENTO		TA  ON HA.ID_TIPO_PAGAMENTO		= TA.ID
		LEFT  JOIN	[DB_SISCOB].[AUXILIAR].TB_PAGTO_AJUSTE			PG  ON CS.ID_PGTO_AJUSTE		= PG.ID
		LEFT  JOIN	[DB_SISCOB].[AUXILIAR].TB_JURIDICO				J   ON CS.ID_JURIDICO			= J.ID
		LEFT  JOIN	[DB_SISCOB].[AUXILIAR].TB_ANALISE_CONTA			AC  ON CS.ID_ANALISE_CONTA		= AC.ID
		LEFT JOIN	[DB_SISCOB].[APP_WEB].[TBL_USUARIOS]			AN	ON CS.ID_ANALISTA			= AN.id_user
		LEFT JOIN	[DB_SISCOB].[APP_WEB].[TBL_USUARIOS]			ANT	ON CS.ID_ANALISTA_TMP		= ANT.id_user
		LEFT  JOIN  [DB_SISCOB].[APP_WEB].[TBL_AREAS]				A	ON AN.area					= A.id_area	
		LEFT JOIN	[DB_SISCOB].[APP_WEB].[TBL_USUARIOS]			AL	ON A.gestor2				= AL.id_user
		LEFT JOIN   [DB_SISCOB].[AUXILIAR].[TB_STATUS_ESCALATION]   SC	ON CS.ID_STATUS_ESCALATION  = SC.ID
 WHERE
			C.ID_PERIODO = (SELECT MAX(ID) FROM [DB_SISCOB].[AUXILIAR].[TB_PERIODO])
		AND C.ID_SEGMENTO = 1
		AND C.SEG_DESCR IN ('VPE','VPE-GOV')
		AND NOT C.TASK_FORCE = 'DEMAIS'
 


GO


